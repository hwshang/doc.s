## TCP & UDP

---

### 基础知识点

TCP/IP和UDP/IP通信中采用5个信息来识别一个通信，`源IP地址` `目标IP地址` `协议号` `源端口号` `目标端口号`。

操作系统中端口号的分配： 
- 静态 应用程序指定端口号。
- 动态 交给系统进行分配，操作系统为应用程序分配互不冲突的端口号。

端口和协议。数据到达IP层之后，先检查IP首部中的协议号，根据协议号，再传给对应的协议模块。如果是TCP就传给TCP模块处理。所以 *即使是同一个端口号，使用不同的协议，也互不影响。*

---

### UDP

在收到应用程序发来的数据时，立即原样发送到网络上。

---

### TCP

TCP通过 `检验和` `序列号` `确认应答` `重发机制` `连接管理` `窗口控制` 等机制实现可靠传输。

**序列号与确认应答**

序列号是按顺序给发送的每个字节数据都进行编号。序列号作为接收端组装包的顺序依据，也解决了包的乱序问题，

接收端把接收数据的序列号和数据长度相加，作为应答号响应给发送端，发送端按照相应的序列号进行下一步的数据发送。应答号保证了传输的不丢包。

**超时重发**

重发超时是指重发数据之前，等待确认应答到来的时间间隔。重发间隔时间会以指数倍增加，超过一定次数会认为网络或者对端主机异常，强制关闭连接。

**最大消息长度**

简称MSS，值最大长度的包不会被分片传输。在三次握手过程中计算得出，TCP首部的选项中取值进行对比，使用通讯两端较小的值最为MSS。

**窗口控制**

窗口的使用提高了网路通信的效率。窗口指不需要等待确认应答继续发送数据，例如一次连续发送4个段的数据，这4个段成为一个窗口，发送之后等待确认应答，理解为组队。滑动窗口需使用大量的缓冲区。
如果窗口中的部分数据丢失，也会进行重发，所以，在收到确认应带之前，发送的数据必须保留在缓冲区膻中。已经收到确认应答的数据可从缓冲区中清除。

比如窗口里包含1，2，3，4段进行传输，发送端等待确认；
而对端只接收到了1，3，4段，在回复3的时候，因为缺失2的数据，应答号依然与1的应答号一致，确认应答4的时候也是如此；
在发送端连续接收到3次同一个确认应答，就重发相应的数据。这里重发2，这里的重发机制叫做 `高速重发控制` ；
接收端收到2之后，确认应答响应的是4的应答号，因为之前已经将1，3，4缓存到缓冲区。

**滑动窗口**

如果只收到1并进行了确认应带，那么滑动窗口到确认应答中的相应位置。

**流量控制**

发送端根据接收端的实际接收能力控制发送的数据量。接收端将窗口大小通知给发送端，这就是流量控制。

**拥塞控制**

根据网络情况来确定窗口大小，叫做拥塞窗口。以免了原本已经拥堵的网络更加拥堵。
满启动将拥塞窗口定义为1MSS，然后逐渐增加，拥塞窗口越大，确认应答也越大，拥塞窗口的涨幅也会减小。在超时重发时，会设置为当前拥塞窗口的一半。

---

### TCP首部

**源端口号**

16位

**目标端口号**

16位

**序列号**

32位。序列号的初始值是计算机生成的随机数。SYN和FIN包不携带数据，但也会增加序列号。

**确认应答号**

32位。它的值减一等于已经接收的数据长度。发送端可以发送这个值之后的数据。

**数据偏移**

32位。表示数据部分从此TCP包的什么位置开始，也可看作TCP首部的长度。

**保留**

4位。

**控制位**

8位。每个位从左到右表示： `CWR` `ECE` `URG` `ACK` `PSH` `RST` `SYN` `FIN` 。值为 `1`  具有意义。

- CWR  与ECE用于IP首部的ECN字段。
- ECE   为1表示网络拥塞，通知对方缩小拥塞窗口。
- UEG  为1表示包中有需要紧急处理的数据。
- ACK  为1，确认应答字段有效，TCP中除了SYN包之外必须为1。
- PSH  为1，表示需要立刻传数据给上层协议，为0会先缓存。
- RST  为1，表示必须强制断开连接，用于没有被使用的端口的连接请求，比如程序崩溃或者系统宕机。
- SYN  为1，表示希望建立连接，并在序列号字段中进行序列号初始化。
- FIN  为1，表示希望断开连接，不会再发送数据。FIN包也会得到确认应答。

**窗口大小**

16位。表示接收端能够接收的数据大小，TCP不允许发送超过次值大小的数据。
如果值为0，表示是一个窗口探测，获取最新的窗口大小信息。

**校验和**

接收端根据校验和计算出16位全为1，表示数据是正确的。

**紧急指针**

16位。控制位的URG为1时有效，表示本报文中紧急数据的指针。紧急指针就是紧急数据末尾在报文中的位置。一般应用于 `Ctrl+C` ，或者浏览器的停止按钮。

**选项**

用于提高TCP的传输性能。
